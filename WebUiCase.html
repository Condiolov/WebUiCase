<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<style>
						*{
			    margin:0;
			    padding:0;
			    font-family: system-ui; 
			    font-size: 1em;
			    color: #f9f8f6;
			}
			body {
			    background: #1d1e20;
			    font-family: Arial, sans-serif;
			    margin: auto;
			    background:#1d1e20;
			    font-family: Arial, sans-serif;
			}
			#menu{
			    position: fixed;
			    justify-self: anchor-center;
			    z-index: 99999;
			    top: 0;
			    background: #161616;
			    width: 100%;
			}
			button,a {
			    font-weight: bold;
			    height: 25px;
			    font-size: 12px;
			    padding: 5px 10px;
			    background: #111;
			    border: 0 solid #000;
			    color: white;
			    cursor: pointer;
			    border-radius: 5px;
			}
			input,select {
			    font-weight: bold;
			    font-size: 12px;
			    padding: 5px 10px;
			    background: #111;
			    border: 0 solid #000;
			    color: white;
			    cursor: pointer;
			    border-radius: 5px;
			    margin:0 3px
			}
			button:hover {
			    background-color: #45a049;
			}
			.inline {
			    display: flex;
			    justify-content: center;
			    gap: 3px 3px;
			    flex-direction: row;
			    flex-wrap: wrap;
			    color: #f00;
			    padding: 5px 0px;
			    align-items: center;
			}
			.inline .inline{
			    padding: 0px;
			}
			
			.container {
			    max-width: 800px;
			    margin: 0 auto;
			    background-color: white;
			    padding: 20px;
			    border-radius: 8px;
			    box-shadow: 0 0 10px rgba(0,0,0,0.1);
			}
			h1 {
			    color: #333;
			    text-align: center;
			}
			.input-area {
			    margin: 20px 0;
			}
			textarea {
			    width: 100%;
			    height: 100px;
			    padding: 10px;
			    border: 1px solid #ddd;
			    border-radius: 4px;
			    resize: vertical;
			    bottom: 0;
			    justify-self: anchor-center;
			    background: #36383acc;
			    box-sizing: border-box;
			    border: 0;
			    border-radius: 20px;
			    padding: 13px;
			    margin-bottom:2vh;
			    max-height: 80vh;
			}
			.fixo {
			    width: 100%;
			    justify-self: anchor-center;
			    display: flex;
			    position: fixed;
			    bottom: 0;
			    width: 100%;
			    margin: auto;
			    align-items: center;
			    flex-direction: column;
			    max-width: 768px;
			}
			
			textarea:focus {
			    border: 2px solid #555; 
			    outline: none;
			}
			
			#response {
			    width: 100%;
			    justify-self: anchor-center;
			    white-space: pre-wrap;
			    margin-bottom: 150px;
			    margin-top: 50px;
			    display: flex        ;
			    flex-direction: column;
			    max-width: 768px;
			    text-align: justify;
			}
			.hidden{
			    display:none;
			}
			
			eu{
			    float: right;
			    /*     text-align: right; */
			    justify-self: anchor-center;
			    background: #36383acc;
			    box-sizing: border-box;
			    border-radius: 20px 20px 0px 20px;
			    padding: 13px;
			}
			
			ia {
			    float: left;
			    justify-self: anchor-center;
			    background: #36383acc;
			    box-sizing: border-box;
			    border-radius: 20px 20px 20px 0px;
			    padding: 13px;
			}
			
			.CodeMirror {
			    height: auto !important;
			    border-radius: 10px;
			    font-family: monospace; 
			}
			.CodeMirror-linenumbers, .CodeMirror-gutter-elt{
			    user-select: none;
			}
			.legenda{
			    font-size:10px;
			    padding:0 3px;
			    border-radius:5px;
			    background:#fff;
			    color:#000;
			    display:none;   
			    z-index:999999;
			}
			.highlight {
			    background: #868e19; 
			    outline: 2px solid #f00;
			}
			ia p {
			    padding: 10px;
			}
			
			ia ul {
			    padding: 10px 40px; 
			}
			ia h2 {
			    font-size: large;
			}
			ul, li {
			    margin: 0;
			    padding: 0;
			    list-style: inherit; 
			}
			ol {
			    padding: 0 40px 10px;
			}
			
			.ff {
			    margin: 0;
			    padding: 0; 
			    white-space: normal;
			}
			
			code {
			    border-radius: 6px;
			    display: inline;
			    padding: 2px;
			    text-wrap: auto;
			    margin: 10px 0;
			    font-family: monospace;
			    background-color: var(--bg-color);
			    color: var(--color);
			}
			
			
		</style>
	</head>
	<body>
					<div id="menu">
			            <div class="inline">
			                <button class="bttn" onclick="novaConversa()" legenda="Criar nova conversa">WebUiCase</button>
			                <button class="bttn" onclick="changeTheme()" legenda="Trocar tema">üé®</button>
			                <div>
			                    <select id="modelos" name="modelos" legenda="Trocar modelo"> 
			                        <option>llama3.2</option>
			                    </select>
			                </div> 
			                <div class="especial" style="display: inline-flex;border-radius: 5px;">
			                    <button class="bttn" onclick="criarEspecialista()" legenda="Modelos especialistas">üìù</button>
			                    <div class="especialistas hidden">
			                        <select id="especialistas" onchange="carregarEspecialista()" >
			                            <option>Selecione</option>
			                        </select>
			                        <button class="bttn" onclick="editarEspecialista()" legenda="Editar Especialista">‚úèÔ∏è</button>
			                        <button class="bttn" onclick="excluirEspecialista()" legenda="Excluir Especialista">üóëÔ∏è</button>
			                        <button class="bttn" onclick="sairEspecialista('especialistas')" legenda="Fechar Especialista">‚ùå</button>
			                    </div>
			                </div>
			                <button class="bttn" onclick="salvar_conversa()">üíæ</button>
			                <div class="especial" style="display: inline-flex;border-radius: 5px;">
			                    <button class="bttn" onclick="abrirConversas()" legenda="Modelos conversas">üìÇ</button>
			                    <div class="conversas hidden">
			                        <select id="conversas" onchange="carregarConversas()" >
			                            <option>Selecione</option>
			                        </select>            <button class="bttn" onclick="excluirConversas()" legenda="Excluir Conversas">üóëÔ∏è</button>
			                        <button class="bttn" onclick="sairEspecialista('conversas')" legenda="Fechar Especialista">‚ùå</button>
			                    </div>
			                </div> 
			                <div class="inline busca hidden">
			                    <input class="bttn" type="text" oninput="findNext()" id="find"/><button class="bttn" onclick="findNext()">üîç<span id="count-display" class="count-display"></span></button>
			
			                </div>      
			
			                <button class="bttn" id="toggle-search" onclick="busca_palavra(this)">üîç</button>
			                <button class="bttn" legenda="Fecha o WebUiCase" onclick="window.location.href='/sair'; setTimeout(window.close, 10);" style="margin-left: 7vw;">üíÄ</button>
			            </div> 
			        </div>
			
			        <div id="response"></div>
			
			        <div class="fixo"> 
			            <button id="toggle-scroll" onclick="toggleAutoScroll()" style="display:none"></button>
			            <textarea id="prompt" autofocus placeholder="Digite sua mensagem aqui..."  oninput="this.style.height = ''; this.style.height = this.scrollHeight +'px'"></textarea> 
			        </div>
			
			        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
			        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/ambiance.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/searchcursor.min.js"></script>
			
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/xml-hint.min.js"></script> 
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/html-hint.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/css-hint.min.js"></script> 
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/javascript-hint.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closetag.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/lint/lint.min.js"></script>
			        <!-- 		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/lint/html-lint.min.js"></script> -->
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/comment/comment.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/searchcursor.js"></script>
			        <script src="https://markdownlivepreview.com/js/marked.min.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/search.js"></script>
			        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/matchbrackets.min.js"></script>
		<script>			let promptHistory = [];
			let historyIndex = -1; 
			edit_especialista=false;
			
			let sytemPrompt = "";
			let historico = [];
			let isAutoScrollEnabled = true;
			let nomeEspecialista;
			const themes = ["3024-day", "3024-night", "abbott", "abcdef", "ambiance", "ayu-dark", "ayu-mirage","base16-dark", "bespin", "base16-light", "blackboard", "cobalt", "colorforth","dracula", "duotone-dark", "duotone-light", "eclipse", "elegant", "erlang-dark","gruvbox-dark", "hopscotch", "icecoder", "isotope", "juejin", "lesser-dark","liquibyte", "lucario", "material", "material-darker", "material-palenight","material-ocean", "mbo", "mdn-like", "midnight", "monokai", "moxer", "neat","neo", "night", "nord", "oceanic-next", "panda-syntax", "paraiso-dark","paraiso-light", "pastel-on-dark", "railscasts", "rubyblue", "seti", "shadowfox","solarized", "the-matrix", "tomorrow-night-bright", "tomorrow-night-eighties","ttcn", "twilight", "vibrant-ink", "xq-dark", "xq-light", "yeti", "idea","darcula", "yonce", "zenburn"];
			
			// √çndice do tema atual
			let currentThemeIndex = 4; 
			const responseDiv = document.getElementById('response');
			
			async function sendPrompt() {
			    const promptInput = document.getElementById('prompt');
			    const prompt = promptInput.value.trim();
			    promptHistory.push(prompt);
			    historyIndex = -1; // Reseta o √≠ndice para permitir nova entrada
			
			    const para_salvarDiv = document.getElementById('para_salvar');
			    const selectModelos = document.getElementById('modelos');
			    const modeloSelecionado = selectModelos.value; 
			
			    if (!prompt) return;
			
			    historico.push({ role: "user", content: prompt });
			
			    responseDiv.innerHTML += `<balao><eu> ${escapeHtml(prompt)}</eu></balao><br>`;
			
			    promptInput.value = "";
			    promptInput.style.height="";
			
			    const fullPrompt = historico.map(msg => `${msg.role}: ${msg.content}`).join('\n');
			
			    const response = await fetch('http://localhost:11434/api/generate', {
			        method: 'POST',
			        headers: {
			            'Content-Type': 'application/json',
			        },
			        body: JSON.stringify({
			            model: modeloSelecionado || 'llama3.2', 
			            prompt: fullPrompt,
			            stream: true,
			            system: sytemPrompt,
			        })
			    });
			
			    if (!response.ok) {
			        throw new Error('Erro na requisi√ß√£o');
			    }
			
			    const reader = response.body.getReader();
			    const decoder = new TextDecoder();
			    let aiResponse = ""; // Acumula a resposta da IA)
			
			    const tempResponse2 = document.createElement('balao');
			    responseDiv.appendChild(tempResponse2);
			    const tempResponse = document.createElement('ia');
			    tempResponse2.appendChild(tempResponse);
			    currentDiv = createNewFragmentDiv(tempResponse);
			    while (true) {
			        const { done, value } = await reader.read();
			        if (done) break;
			
			        const chunk = decoder.decode(value);
			        const lines = chunk.split('\n');
			
			        for (const line of lines) {
			            if (line.trim()) {
			                const data = JSON.parse(line);
			                if (data.response) {
			                    aiResponse += data.response; 
			                    estilizar(data.response,tempResponse);
			                    const responseDiv = document.getElementById('response');
			                    if (isAutoScrollEnabled)
			                        window.scrollBy(0, responseDiv.scrollHeight); 
			                }               
			            }
			        }
			    }
			
			    historico.push({ role: "assistant", content: aiResponse });
			    responseDiv.innerHTML += '<br>'; 
			    document.getElementById("prompt").focus();
			}
			
			
			async function carregarModelosOllama() {
			    const selectModelos = document.getElementById('modelos');
			
			    const response = await fetch('http://localhost:11434/api/tags', {
			        method: 'GET',
			        headers: {
			            'Content-Type': 'application/json',
			        }
			    });
			
			    if (!response.ok) {
			        responseDiv.innerHTML += `<ia><strong>Erro:</strong> Erro ao carregar os modelos do Ollama</ia><br>`;          
			    }
			
			    const data = await response.json();
			    const modelos = data.models;
			
			    modelos.forEach(modelo => {
			        if(modelo.name.includes("llama3.2"))return;
			        const nomeModelo = modelo.name || modelo.model;
			        const option = document.createElement('option');
			        option.value = nomeModelo;
			        option.textContent = nomeModelo;
			        selectModelos.appendChild(option);
			    }); 
			}
			
			document.addEventListener('keydown', function(event) {
			    const prompt = document.getElementById('prompt');
			
			    if (event.shiftKey && event.key === 'Enter') {
			        const cursorPosition = prompt.selectionStart;
			        const lineBefore = prompt.value.substring(0, cursorPosition);
			        const lineAfter = prompt.value.substring(cursorPosition);
			        prompt.value = lineBefore + '\n' + lineAfter;
			        prompt.selectionStart = prompt.selectionEnd = cursorPosition + 1;
			    } else if (event.key === 'Enter') {
			        event.preventDefault();
			        sendPrompt();
			    } else if (prompt.value == "" && event.key === 'ArrowUp') {
			        event.preventDefault();
			        if (promptHistory.length === 0) return; 
			        if (historyIndex === -1) {
			            historyIndex = promptHistory.length - 1;
			        } else if (historyIndex > 0) {
			            historyIndex--; 
			        }
			
			        prompt.value = promptHistory[historyIndex];
			        prompt.selectionStart = prompt.selectionEnd = prompt.value.length; 
			    } else if (prompt.value == ""  && event.key === 'ArrowDown') {
			        event.preventDefault();
			        if (promptHistory.length === 0 || historyIndex === -1) return;
			
			        if (historyIndex < promptHistory.length - 1) {
			            historyIndex++; // Move para o pr√≥ximo item
			            prompt.value = promptHistory[historyIndex];
			        } else {
			            historyIndex = -1;
			            prompt.value = '';
			        }
			        prompt.selectionStart = prompt.selectionEnd = prompt.value.length; 
			    }
			});
			
			const language_list = {
			    'bash': 'shell',
			    'python': 'python',
			    'js': 'javascript',
			    'javascript': 'javascript',
			    'css': 'css',
			    'html': 'htmlmixed',
			    'c': 'clike'
			};
			function loadModeScript(language) {
			    const mode = language_list[language] || language || 'plaintext'; 
			    const scriptUrl = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/${mode}/${mode}.min.js`;
			
			    if (!document.querySelector(`script[src="${scriptUrl}"]`)) {
			        const script = document.createElement('script');
			        script.src = scriptUrl;
			        script.async = false; // Carrega na ordem
			        document.head.appendChild(script);
			        return new Promise((resolve) => {
			            script.onload = resolve; 
			        });
			    }
			    return Promise.resolve(); 
			}
			
			
			function busca_palavra(button) {
			    const buscaElements = document.querySelectorAll('.busca');
			    const isHidden = buscaElements[0].classList.contains('hidden'); 
			
			    if (isHidden) {
			        buscaElements.forEach(element => {
			            element.classList.remove('hidden');
			        });
			        button.textContent = '‚ùå'; // Emoji de fechar no bot√£o
			    } else {
			        const previousHighlights = document.querySelectorAll('.highlight');
			        previousHighlights.forEach(highlight => {
			            const parent = highlight.parentNode;
			            parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
			            parent.normalize(); // Junta n√≥s de texto adjacentes
			        });
			        buscaElements.forEach(element => {
			            element.classList.add('hidden');
			        });
			        button.textContent = 'üîç'; // Emoji de lupa no bot√£o
			    }
			}
			
			let currentHighlightIndex = -1; 
			
			function findNext() {
			    const findInput = document.getElementById('find');
			    const searchText = findInput.value.trim();
			    if (!searchText) return;
			    const previousHighlights = document.querySelectorAll('.highlight');
			    previousHighlights.forEach(highlight => {
			        const parent = highlight.parentNode;
			        parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
			        parent.normalize(); 
			    });
			
			    const walker = document.createTreeWalker(
			        document.body,
			        NodeFilter.SHOW_TEXT,
			        null,
			        false
			    );
			
			    const textNodes = [];
			    let node;
			    while ((node = walker.nextNode())) {
			        if (node.nodeValue.trim() && node.parentNode.tagName !== 'SCRIPT' && node.parentNode.tagName !== 'STYLE') {
			            textNodes.push(node);
			        }
			    }
			
			    const regex = new RegExp(`(${searchText})`, 'gi');
			    textNodes.forEach(textNode => { 
			        if (regex.test(textNode.nodeValue)) {
			            const fragment = document.createDocumentFragment();
			            const parts = textNode.nodeValue.split(regex);
			            parts.forEach(part => {
			                if (part.toLowerCase() === searchText.toLowerCase()) {
			                    const span = document.createElement('span');
			                    span.className = 'highlight';
			                    span.textContent = part;
			                    fragment.appendChild(span);
			                } else {
			                    fragment.appendChild(document.createTextNode(part));
			                }
			            });
			            textNode.parentNode.replaceChild(fragment, textNode);
			        }
			    });
			
			    const highlights = document.querySelectorAll('.highlight');
			    if (highlights.length > 0) {
			        if (currentHighlightIndex ===
			
			            -1 || highlights.length <= currentHighlightIndex) {
			            currentHighlightIndex = 0; 
			        } else {
			            currentHighlightIndex = (currentHighlightIndex + 1) % highlights.length; 
			        }
			        const nextHighlight = highlights[currentHighlightIndex];
			        if (nextHighlight) {
			            nextHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
			        }
			    }
			}
			
			
			function toggleAutoScroll() {
			    const toggleButton = document.getElementById('toggle-scroll'); 
			    window.scrollTo({
			        top: document.documentElement.scrollHeight,
			        behavior: 'smooth' 
			    });
			    isAutoScrollEnabled = true;
			    toggleButton.style.display = 'none';
			}
			
			window.addEventListener('wheel', (event) => {
			    const toggleButton = document.getElementById('toggle-scroll');  
			    if (event.deltaY < 0) { 
			        if (isAutoScrollEnabled) { 
			            isAutoScrollEnabled = false;
			            toggleButton.textContent = 'üîª';
			            toggleButton.style.display = 'block';
			        }
			    }
			    const scrollPosition = window.scrollY + window.innerHeight;
			    const documentHeight = document.documentElement.scrollHeight;
			
			    if (scrollPosition >= documentHeight - 1) 
			        toggleButton.style.display = 'none'; 
			    else 
			        toggleButton.style.display = 'block'; 
			});
			
			function editarEspecialista(){
			    edit_especialista=true;
			    carregarEspecialista()
			}
			
			function excluirEspecialista(){
			    edit_especialista=false;
			    const especialistas = JSON.parse(localStorage.getItem('especialistas')) || {};
			    delete especialistas[nomeEspecialista];
			    localStorage.setItem('especialistas', JSON.stringify(especialistas));
			    select_especialista(); 
			}
			function sairEspecialista(fechar){
			    const botao = event.currentTarget;
			    const divEspecial = botao.closest('.especial');
			    divEspecial.style.outline = '';
			    divEspecial.querySelector('.' + fechar).classList.add('hidden');
			
			}
			function criarEspecialista() {
			    const botao = event.currentTarget;
			    const divEspecial = botao.closest('.especial');
			    divEspecial.style.outline = '1px solid';
			    const promptText = document.getElementById('prompt').value.trim();
			    if (promptText === '') { 
			        const selectEspecialistas = document.querySelector('.especialistas');
			        selectEspecialistas.classList.remove('hidden');
			        select_especialista();
			    } else {
			        nomeEspecialista = window.prompt('Digite o nome do especialista:', nomeEspecialista);
			        if (nomeEspecialista) { 
			            const especialistas = JSON.parse(localStorage.getItem('especialistas') || '{}');
			            especialistas[nomeEspecialista] = promptText;
			            localStorage.setItem('especialistas', JSON.stringify(especialistas));
			            document.getElementById('prompt').value = '';
			            select_especialista(); 
			            edit_especialista=false;
			        }
			    }
			} 
			
			function select_especialista() {
			    const selectEspecialistas = document.getElementById('especialistas');
			    selectEspecialistas.innerHTML = '';
			
			    const optionDefault = document.createElement('option');
			    optionDefault.value = '';
			    optionDefault.textContent = 'Selecione';
			    selectEspecialistas.appendChild(optionDefault);
			
			    const especialistas = JSON.parse(localStorage.getItem('especialistas') || '{}');
			    for (const [nome, texto] of Object.entries(especialistas)) {
			        const option = document.createElement('option');
			        option.value = nome;
			        option.textContent = nome;
			        selectEspecialistas.appendChild(option);
			    }
			} 
			
			
			function carregarEspecialista() {
			    const selectEspecialistas = document.getElementById('especialistas');
			    nomeEspecialista = selectEspecialistas.value;
			    if (nomeEspecialista) { 
			        const especialistas = JSON.parse(localStorage.getItem('especialistas') || '{}');
			        if (edit_especialista)
			            document.getElementById('prompt').value = especialistas[nomeEspecialista] || '';
			        else
			            sytemPrompt= especialistas[nomeEspecialista];
			    }
			}
			
			
			document.addEventListener('mouseover', function(event) {
			    if (event.target.hasAttribute('legenda')) {
			        const toolTip = event.target.getAttribute('legenda');
			        const legenda = document.createElement('span');
			        legenda.className = 'legenda';
			        legenda.textContent = toolTip;
			        legenda.style.position = 'absolute';
			        legenda.style.top = `${event.pageY - 10}px`;
			        legenda.style.left = `${event.pageX + 20}px`;
			        legenda.style.display = 'none';
			        document.body.appendChild(legenda);
			        setTimeout(() => {
			            legenda.style.display = 'block';
			            legenda.style.opacity = '1';
			            legenda.style.transition = 'opacity 1s';
			        }, 100);
			    }
			});
			
			document.addEventListener('mouseout', function(event) {
			    if (event.target.hasAttribute('legenda')) {
			        const legenda = document.querySelector('.legenda');
			        if (legenda) legenda.remove();
			    }
			});
			
			document.addEventListener('mousemove', function(event) {
			    const legenda = document.querySelector('.legenda');
			    if (legenda) {
			        legenda.style.top = `${event.pageY +10}px`; 
			        legenda.style.left = `${event.pageX + 20}px`;
			    }
			});
			
			
			function salvar_conversa(){
			    const iaElement = document.querySelector('ia');
			    const texto = iaElement.textContent;
			    const regex = /\*\*(.*?)\*\*/;
			    const match = texto.match(regex);
			    const resultado = match ? match[1] : '';
			    conversa_nome = window.prompt('Nome para conversa:', resultado);
			    if (conversa_nome) { 
			        const conversas = JSON.parse(localStorage.getItem('conversas') || '{}');
			        conversas[conversa_nome] = historico;
			        localStorage.setItem('conversas', JSON.stringify(conversas));
			        carregarConversasSelect()
			    }
			}
			
			function abrirConversas (){
			    const botao = event.currentTarget;
			    const divEspecial = botao.closest('.especial');
			    divEspecial.style.outline = '1px solid';
			    const selectConversas = document.querySelector('.conversas');
			    selectConversas.classList.remove('hidden');
			    carregarConversasSelect()
			}
			
			function carregarConversasSelect() {
			    const selectConversas = document.getElementById('conversas');
			    selectConversas.innerHTML = '';
			    const optionSelecao = document.createElement('option');
			    optionSelecao.value = 'Selecione'; 
			    optionSelecao.textContent = 'Selecione';
			    selectConversas.appendChild(optionSelecao);
			
			    const conversas = JSON.parse(localStorage.getItem('conversas') || '{}');
			    for (const [nome, texto] of Object.entries(conversas)) {
			        const option = document.createElement('option');
			        option.value = nome;
			        option.textContent = nome;
			        selectConversas.appendChild(option);
			    }
			}
			function excluirConversas(){
			    let nomeConversas=  document.getElementById('conversas').value
			    const conversas = JSON.parse(localStorage.getItem('conversas')) || {};
			    delete conversas[nomeConversas];
			    localStorage.setItem('conversas', JSON.stringify(conversas));
			    carregarConversasSelect(); 
			}
			function novaConversa(){
			    responseDiv.innerHTML="";
			    historico = [];
			}
			
			function carregarConversas (){
			    responseDiv.innerHTML="";
			    const selectConversas = document.getElementById('conversas');
			    nomeConversas = selectConversas.value;
			    if (nomeConversas == "Selecione") return;
			    const conversas = JSON.parse(localStorage.getItem('conversas') || '{}');
			    historico = conversas[nomeConversas];
			    historico.forEach((mensagem) => { 
			        const tag = document.createElement(mensagem.role === 'user' ? 'eu' : 'ia'); const balao = document.createElement('balao');
			        responseDiv.appendChild(balao);
			        if (mensagem.role === 'user'){
			            tag.textContent = mensagem.content;
			        }else{
			            if (mensagem.content.includes('```')) {
			                const parts = mensagem.content.split('```');
			                let htmlContent = '';
			                let inCodeBlock = false;
			
			                parts.forEach((part, index) => {
			                    setTimeout(() => {
			                        if (inCodeBlock) {
			                            inCodeBlock = false;
			                            const linhas = part.split('\n');
			                            language = linhas[0].trim();
			                            const removePrimeiraLinha = linhas.slice(1);
			                            part = removePrimeiraLinha.join('\n');
			                            divCode = tag; 
			                            cm = createCodeMirrorInstance();
			                            cm.setValue(part);
			                            cm.setSelection({ line: 0, ch: 0 }, { line: cm.lastLine(), ch: 300 });
			                            cm.execCommand('indentAuto');
			                        } else {
			                            tag.innerHTML += marked.parse(part);
			                            balao.appendChild(tag)
			                            inCodeBlock = true;
			                        } 
			                    }, 100); 
			                });
			                tag.innerHTML = htmlContent;
			            } else {
			                tag.innerHTML += marked.parse(mensagem.content);
			            }
			        }
			        balao.innerHTML += '<br>';
			        balao.appendChild(tag)
			    });
			}
			
			let tem_Code = false;
			let fullText ="";let codigo = '';
			let accumulatedMarkdown = ""; 
			let currentDiv = null; 
			let divCode = null;
			let cm = null;
			renderiza=false 
			let language;
			tem_Code = false 
			
			function carrega_tema() {
			    const newTheme = themes[currentThemeIndex];
			    const themeUrl = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/${newTheme}.min.css`;
			    const existingThemeLink = document.querySelector(`link[data-codemirror-theme="${newTheme}"]`);
			    if (existingThemeLink) return; 
			    const oldThemeLink = document.querySelector('link[data-codemirror-theme]');
			    if (oldThemeLink) oldThemeLink.remove();
			    const themeLink = document.createElement('link');
			    themeLink.rel = 'stylesheet';
			    themeLink.href = themeUrl;
			    themeLink.dataset.codemirrorTheme = newTheme; 
			    document.head.appendChild(themeLink);
			    document.querySelectorAll('.CodeMirror').forEach(cm => {
			        cm.classList.remove( "cm-s-"+themes[currentThemeIndex-1]);
			        cm.classList.add("cm-s-"+newTheme);
			    });
			}
			
			function changeTheme() {
			    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
			    carrega_tema();
			    setTimeout(() => {
			        const tema = document.querySelector(".cm-s-" + themes[currentThemeIndex]);
			        if (tema) {
			            const computedStyles = window.getComputedStyle(tema);
			            document.documentElement.style.setProperty('--color', computedStyles.color);
			            document.documentElement.style.setProperty('--bg-color', computedStyles.backgroundColor);
			        }
			    }, 500);
			}
			
			function createCodeMirrorInstance() {
			    const textarea = document.createElement('textarea'); 
			    divCode.appendChild(textarea);
			    cm = CodeMirror.fromTextArea(textarea, {
			        lineNumbers: true,
			        theme: themes[currentThemeIndex],
			        viewportMargin: Infinity,
			        lineWrapping: true,
			        readOnly: false,
			        indentUnit: 4,
			        inputStyle: 'contenteditable'
			    });
			    return cm;
			}
			
			function createNewFragmentDiv(tempResponse) {
			    const div = document.createElement('div');
			    div.className = 'ff';
			    tempResponse.appendChild(div);
			    return div;
			}
			
			function estilizar (fragment,tempResponse){
			    if (!fragment) return '';
			    codigo += fragment; 
			    if (tem_Code) {
			
			
			        if (!language){
			            const match = codigo.match(/```(\w+)/);
			            codigo = ""; 
			            fragment="";
			            language = match ? match[1] : null;
			            carrega_tema();
			            return;
			        }
			        //         if (fragment.includes('`\n')) {  
			        if (codigo.includes('`\n')) {
			            tem_Code = false; 
			            fragment=""; 
			            language="";
			            codigo=""; 
			            currentDiv = createNewFragmentDiv(tempResponse);
			            return;
			        }    
			
			        cm.replaceRange(fragment.replace(/```|``/g, ''), { 
			            line: cm.lastLine(),
			            ch: cm.getLine(cm.lastLine()).length });
			
			        return; 
			    } 
			    if (fragment.includes('```')){
			        codigo += fragment; 
			        tem_Code = true; 
			        divCode = createNewFragmentDiv(tempResponse); 
			        cm = createCodeMirrorInstance(); 
			        return 
			    }
			
			    if (!tem_Code) 
			        currentDiv.appendChild(document.createTextNode(fragment));
			
			    accumulatedMarkdown += fragment;
			
			    if (fragment.includes('\n')) renderiza = true
			    if (fragment.includes('|\n')) {renderiza =false; isTable= true;}
			    if (fragment.includes('* ')|fragment.includes('- ')) renderiza = false
			
			    if (renderiza) {
			        const selection = window.getSelection();
			        const selectedRange = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
			        currentDiv.innerHTML = marked.parse(accumulatedMarkdown);
			        if (selectedRange) {
			            selection.removeAllRanges();
			            selection.addRange(selectedRange);
			        }
			        accumulatedMarkdown = "";
			        currentDiv = createNewFragmentDiv(tempResponse);
			        renderiza=false;
			    }
			} 
			
			window.onload = function() { 
			    carregarModelosOllama();
			    document.getElementById("prompt").focus();
			
			}
			
			function escapeHtml(unsafe) {
			    return unsafe
			        .replace(/&/g, "&amp;")
			        .replace(/</g, "&lt;")
			        .replace(/>/g, "&gt;")
			        .replace(/"/g, "&quot;")
			        .replace(/'/g, "&#039;");
			}
			
			
		</script>
	</body>
</html>