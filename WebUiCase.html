<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<style>
						*{
			    margin:0;
			    padding:0;
			    font-family: system-ui; 
			    font-size: 1em;
			    color: #f9f8f6;
			}
			body {
			    background: #1d1e20;
			    font-family: Arial, sans-serif;
			    margin: auto;
			    background:#1d1e20;
			    font-family: Arial, sans-serif;
			}
			#menu{
			    position: fixed;
			    justify-self: anchor-center;
			    z-index: 99999;
			    top: 0;
			    background: #161616;
			    width: 100%;
			}
			button {
			    font-weight: bold;
			    height: 25px;
			    font-size: 12px;
			    padding: 5px 10px;
			    background: #111;
			    border: 0 solid #000;
			    color: white;
			    cursor: pointer;
			    border-radius: 5px;
			}
			input,select {
			    font-weight: bold;
			    font-size: 12px;
			    padding: 5px 10px;
			    background: #111;
			    border: 0 solid #000;
			    color: white;
			    cursor: pointer;
			    border-radius: 5px;
			    margin:0 3px
			}
			button:hover {
			    background-color: #45a049;
			}
			.inline {
			    display: flex;
			    justify-content: center;
			    gap: 3px 3px;
			    flex-direction: row;
			    flex-wrap: wrap;
			    color: #f00;
			    padding: 5px 0px;
			    align-items: center;
			}
			.inline .inline{
			    padding: 0px;
			}
			
			.container {
			    max-width: 800px;
			    margin: 0 auto;
			    background-color: white;
			    padding: 20px;
			    border-radius: 8px;
			    box-shadow: 0 0 10px rgba(0,0,0,0.1);
			}
			h1 {
			    color: #333;
			    text-align: center;
			}
			.input-area {
			    margin: 20px 0;
			}
			textarea {
			    width: 100%;
			    height: 100px;
			    padding: 10px;
			    border: 1px solid #ddd;
			    border-radius: 4px;
			    resize: vertical;
			    bottom: 0;
			    justify-self: anchor-center;
			    background: #36383acc;
			    box-sizing: border-box;
			    border: 0;
			    border-radius: 20px;
			    padding: 13px;
			    margin-bottom:2vh;
			}
			.fixo {
			    width: 100%;
			    justify-self: anchor-center;
			    display: flex;
			    position: fixed;
			    bottom: 0;
			    width: 100%;
			    margin: auto;
			    align-items: center;
			    flex-direction: column;
			    max-width: 768px;
			}
			
			textarea:focus {
			    border: 2px solid #555; 
			    outline: none;
			}
			
			#response {
			    width: 100%;
			    justify-self: anchor-center;
			    white-space: pre-wrap;
			    margin-bottom: 110px;
			    margin-top: 50px;
			    display: flex
			        ;
			    flex-direction: column;
			    max-width: 768px;
			}
			.hidden{
			    display:none;
			}
			eu{
			    display: flex;
			    margin: 10px;
			    justify-self: anchor-center;
			    background: #36383acc;
			    box-sizing: border-box;
			    border-radius: 20px 20px 0px 20px;
			    padding: 13px;   
			}
			ia {
			    width: 100%;
			    color: #c9c9c9;
			    text-align: justify;
			    justify-self: anchor-center;
			    background: #141414cc;
			    box-sizing: border-box;
			    border-radius: 20px 20px 20px 0px;
			    padding: 13px;
			}
			.code-container {
			    width: 100%; 
			    max-width: 100%; 
			    overflow: auto; 
			    border: 1px solid #ddd;
			    margin: 10px 0; 
			}
			
			.CodeMirror {
			    height: auto !important;
			    border-radius: 10px;
			    font-family: monospace; 
			}
			.legenda{
			    font-size:10px;
			    padding:0 3px;
			    border-radius:5px;
			    background:#fff;
			    color:#000;
			    display:none;   
			    z-index:999999;
			}
			.highlight {
			    background: #868e19; 
			    outline: 2px solid #f00;
			}
			ia p {
			    padding: 10px;
			}
			
			ia ul {
			    padding: 10px 40px; 
			}
			ia h2 {
			    font-size: large;
			}
			ul, li {
			    margin: 0;
			    padding: 0;
			    list-style: inherit; 
			}
			ol {
			    padding: 0 40px 10px;
			}
			
			.ff {
			    margin: 0;
			    padding: 0; 
			}
			
			.ff {
			    margin-bottom: 0; 
			    white-space: normal;
			}
			
			code {
			    border-radius: 6px;
			    display: inline;
			    padding: 2px;
			    text-wrap: auto;
			    margin: 10px 0;
			    font-family: monospace;
			    background-color: var(--bg-color);
			    color: var(--color);
			}
			
		</style>
	</head>
	<body>
					<div id="menu">
			    <div class="inline">
			        <button class="bttn" onclick="novaConversa()" legenda="Renomear Arquivo">WebUiCase</button>
			        <button class="bttn" onclick="nomeiaConversa()" legenda="Renomear Arquivo">‚úèÔ∏è</button>
			        <button class="bttn" onclick="changeTheme()" legenda="Trocar tema">üé®</button>
			        <div>
			
			            <select id="modelos" name="modelos" legenda="Trocar modelo"> 
			                <option>llama3.2</option>
			            </select>
			        </div> 
			        <div class="especial" style="display: inline-flex;border-radius: 5px;">
			            <button class="bttn" onclick="criarEspecialista()" legenda="Modelos especialistas">üìù</button>
			            <div class="especialistas hidden">
			                <select id="especialistas" onchange="carregarEspecialista()" >
			                    <option>Selecione</option>
			                </select>
			                <button class="bttn" onclick="editarEspecialista()" legenda="Editar Especialista">‚úèÔ∏è</button>
			                <button class="bttn" onclick="excluirEspecialista()" legenda="Excluir Especialista">üóëÔ∏è</button>
			                <button class="bttn" onclick="sairEspecialista('especialistas')" legenda="Fechar Especialista">‚ùå</button>
			            </div>
			        </div>
			        <button class="bttn" onclick="salvar_conversa()">üíæ</button>
			        <div class="especial" style="display: inline-flex;border-radius: 5px;">
			            <button class="bttn" onclick="abrirConversas()" legenda="Modelos conversas">üìÇ</button>
			            <div class="conversas hidden">
			                <select id="conversas" onchange="carregarConversas()" >
			                    <option>Selecione</option>
			                </select>            <button class="bttn" onclick="excluirConversas()" legenda="Excluir Conversas">üóëÔ∏è</button>
			                <button class="bttn" onclick="sairEspecialista('conversas')" legenda="Fechar Especialista">‚ùå</button>
			            </div>
			        </div>
			        <div class="inline busca hidden">
			            <input class="bttn" type="text" oninput="findNext()" id="find"/><button class="bttn" onclick="findNext()">üîç<span id="count-display" class="count-display"></span></button>
			
			        </div>
			
			        <button class="bttn" id="toggle-search" onclick="busca_palavra(this)">üîç</button>
			    </div> 
			</div>
			
			<div id="response"></div>
			
			<div class="fixo">
			    <button id="toggle-scroll" onclick="toggleAutoScroll()" style="display:none"></button>
			    <textarea id="prompt" placeholder="Digite sua mensagem aqui..."  oninput="this.style.height = ''; this.style.height = this.scrollHeight +'px'">Crie uma pagina simples em html</textarea>
			</div>
			
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/ambiance.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/searchcursor.min.js"></script>
			
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/xml-hint.min.js"></script> 
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/html-hint.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/css-hint.min.js"></script> 
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/javascript-hint.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closetag.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/lint/lint.min.js"></script>
			<!-- 		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/lint/html-lint.min.js"></script> -->
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/comment/comment.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/searchcursor.js"></script>
			<script src="https://markdownlivepreview.com/js/marked.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/search.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/matchbrackets.min.js"></script>
		<script>			// Vari√°vel para armazenar o hist√≥rico de mensagens (contexto)
			// console.clear();
			let promptHistory = [];
			let historyIndex = -1; // √çndice atual no hist√≥rico (-1 significa nenhum hist√≥rico selecionado)
			edit_especialista=false;
			let sytemPrompt = "";
			let conversationHistory = [];
			let isAutoScrollEnabled = true;
			let nomeEspecialista;
			const themes = ["3024-day", "3024-night", "abbott", "abcdef", "ambiance", "ayu-dark", "ayu-mirage","base16-dark", "bespin", "base16-light", "blackboard", "cobalt", "colorforth","dracula", "duotone-dark", "duotone-light", "eclipse", "elegant", "erlang-dark","gruvbox-dark", "hopscotch", "icecoder", "isotope", "juejin", "lesser-dark","liquibyte", "lucario", "material", "material-darker", "material-palenight","material-ocean", "mbo", "mdn-like", "midnight", "monokai", "moxer", "neat","neo", "night", "nord", "oceanic-next", "panda-syntax", "paraiso-dark","paraiso-light", "pastel-on-dark", "railscasts", "rubyblue", "seti", "shadowfox","solarized", "the-matrix", "tomorrow-night-bright", "tomorrow-night-eighties","ttcn", "twilight", "vibrant-ink", "xq-dark", "xq-light", "yeti", "idea","darcula", "yonce", "zenburn"];
			
			// √çndice do tema atual
			let currentThemeIndex = 4;
			
			
			// var promptEditor = CodeMirror(document.getElementById('prompt-editor'), {
			//     mode: 'html', // Modo de realce de sintaxe (ajuste conforme necess√°rio)
			//     lineNumbers: true, // Numera√ß√£o de linhas)
			// });
			const responseDiv = document.getElementById('response');
			
			
			async function sendPrompt() {
			    const promptInput = document.getElementById('prompt');
			    const prompt = promptInput.value.trim();
			    promptHistory.push(prompt);
			    historyIndex = -1; // Reseta o √≠ndice para permitir nova entrada
			
			    const para_salvarDiv = document.getElementById('para_salvar');
			    const selectModelos = document.getElementById('modelos');
			    const modeloSelecionado = selectModelos.value; // Pega o modelo selecionado
			    // Se o prompt for sobre listar modelos
			
			
			    //     console.log("----------",prompt);
			    if (!prompt) {
			        responseDiv.innerHTML += "<ia>Por favor, digite um prompt!</ia><br>";
			        return;
			    } 
			
			    // Adiciona a pergunta ao hist√≥rico
			    conversationHistory.push({ role: "user", content: prompt });
			
			    // Exibe a pergunta na tela antes de enviar
			    function escapeHtml(unsafe) {
			        return unsafe
			            .replace(/&/g, "&amp;")
			            .replace(/</g, "&lt;")
			            .replace(/>/g, "&gt;")
			            .replace(/"/g, "&quot;")
			            .replace(/'/g, "&#039;");
			    }
			
			    responseDiv.innerHTML += `<eu><strong>Voc√™:</strong> ${escapeHtml(prompt)}</eu><br>`;
			    // Limpa o campo de input
			    promptInput.value = "";
			    promptInput.style.height="";
			
			    //     try {
			    // Constr√≥i o prompt com o hist√≥rico de conversa
			    const fullPrompt = conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n');
			
			    const response = await fetch('http://localhost:11434/api/generate', {
			        method: 'POST',
			        headers: {
			            'Content-Type': 'application/json',
			        },
			        body: JSON.stringify({
			            model: modeloSelecionado || 'llama3.2', // Substitua pelo modelo que voc√™ est√° usando)
			            prompt: fullPrompt, // Envia o hist√≥rico completo como prompt)
			            stream: true, // Ativa o streaming)
			            system: sytemPrompt,
			        })
			    });
			
			    if (!response.ok) {
			        throw new Error('Erro na requisi√ß√£o');
			    }
			
			    const reader = response.body.getReader();
			    const decoder = new TextDecoder();
			    let aiResponse = ""; // Acumula a resposta da IA)
			
			    // Cria um cont√™iner tempor√°rio para a nova resposta
			    const tempResponse = document.createElement('ia');
			    responseDiv.appendChild(tempResponse);
			    currentDiv = createNewFragmentDiv(tempResponse);
			    while (true) {
			        const { done, value } = await reader.read();
			        if (done) break;
			
			        const chunk = decoder.decode(value);
			        const lines = chunk.split('\n');
			
			        for (const line of lines) {
			            if (line.trim()) {
			                //                     try {
			                const data = JSON.parse(line);
			                if (data.response) {
			                    aiResponse += data.response; // Acumula a resposta)
			                    //                             tempResponse.innerText += data.response; // Adiciona ao cont√™iner tempor√°rio)
			                    //                             tempResponse.innerHTML+= data.response; 
			                    //                             tempResponse.innerHTML += escapeHtml(data.response);
			                    //                             tempResponse.innerHTML = MarkdownStyler.render(aiResponse);
			                    //                             tempResponse.innerHTML += 
			                    estilizar(data.response,tempResponse);
			                    // Atualiza o CodeMirror em tempo real
			
			                    const responseDiv = document.getElementById('response');
			                    if (isAutoScrollEnabled)
			                        window.scrollBy(0, responseDiv.scrollHeight); // Rolagem autom√°tica)
			                }
			                //                     } catch (e) {
			                //                         console.error('Erro ao parsear linha:', line);
			                //                     }
			            }
			        }
			    }
			
			    // Adiciona a resposta da IA ao hist√≥rico
			    conversationHistory.push({ role: "assistant", content: aiResponse });
			    responseDiv.innerHTML += '<br>'; // Quebra de linha ap√≥s a resposta)
			    //         render_code3();
			    //     } catch (error) {
			    //         responseDiv.innerHTML += `<ia>Erro: ${error.message}</ia><br>`;
			    //     }
			}
			
			
			async function carregarModelosOllama() {
			    const selectModelos = document.getElementById('modelos');
			
			    try {
			        // Faz a requisi√ß√£o para listar os modelos
			        const response = await fetch('http://localhost:11434/api/tags', {
			            method: 'GET',
			            headers: {
			                'Content-Type': 'application/json',
			            }
			        });
			
			        if (!response.ok) {
			            throw new Error('Erro ao carregar os modelos do Ollama');
			        }
			
			        const data = await response.json();
			        const modelos = data.models;
			
			        modelos.forEach(modelo => {
			            if(modelo.name.includes("llama3.2"))return;
			
			            const nomeModelo = modelo.name || modelo.model;
			            const option = document.createElement('option');
			            option.value = nomeModelo;
			            option.textContent = nomeModelo;
			            selectModelos.appendChild(option);
			        });
			
			    } catch (error) {
			        selectModelos.innerHTML = `<option value="">Erro: ${error.message}</option>`;
			    }
			}
			function escapeHtml(unsafe) {
			    return unsafe
			        .replace(/&/g, '&amp;')
			        .replace(/</g, '&lt;')
			        .replace(/>/g, '&gt;')
			        .replace(/"/g, '&quot;')
			        .replace(/'/g, '&#039;');
			}
			// Evento para captura do Enter
			document.addEventListener('keydown', function(event) {
			    const prompt = document.getElementById('prompt');
			
			    if (event.shiftKey && event.key === 'Enter') {
			        const cursorPosition = prompt.selectionStart;
			        const lineBefore = prompt.value.substring(0, cursorPosition);
			        const lineAfter = prompt.value.substring(cursorPosition);
			        prompt.value = lineBefore + '\n' + lineAfter;
			        prompt.selectionStart = prompt.selectionEnd = cursorPosition + 1;
			    } else if (event.key === 'Enter') {
			        event.preventDefault();
			        sendPrompt();
			    } else if (event.key === 'ArrowUp') {
			        // Recupera o prompt anterior com a seta para cima
			        event.preventDefault();
			        if (promptHistory.length === 0) return; // Sai se n√£o h√° hist√≥rico
			
			        // Se estamos no in√≠cio ou fora do hist√≥rico, come√ßamos do √∫ltimo item
			        if (historyIndex === -1) {
			            historyIndex = promptHistory.length - 1;
			        } else if (historyIndex > 0) {
			            historyIndex--; // Move para o item anterior
			        }
			
			        prompt.value = promptHistory[historyIndex];
			        prompt.selectionStart = prompt.selectionEnd = prompt.value.length; // Coloca o cursor no final
			    } else if (event.key === 'ArrowDown') {
			        // Recupera o pr√≥ximo prompt com a seta para baixo (opcional)
			        event.preventDefault();
			        if (promptHistory.length === 0 || historyIndex === -1) return;
			
			        if (historyIndex < promptHistory.length - 1) {
			            historyIndex++; // Move para o pr√≥ximo item
			            prompt.value = promptHistory[historyIndex];
			        } else {
			            // Se chegamos ao final, limpa o campo
			            historyIndex = -1;
			            prompt.value = '';
			        }
			        prompt.selectionStart = prompt.selectionEnd = prompt.value.length; // Coloca o cursor no final
			    }
			});
			
			/**
			 * Fun√ß√£o para renderizar blocos de c√≥digo dentro das tags <ia>.
			 * Cria uma inst√¢ncia do CodeMirror para cada bloco de c√≥digo encontrado.
			 */
			const modes = {
			    'bash': 'shell',
			    'python': 'python',
			    'js': 'javascript',
			    'javascript': 'javascript',
			    'css': 'css',
			    'html': 'htmlmixed',
			    'c': 'clike'
			};
			function loadModeScript(language) {
			
			
			    const mode = modes[language] || language || 'plaintext'; // Fallback para 'plaintext'
			    const scriptUrl = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/${mode}/${mode}.min.js`;
			
			    // Verifica se o script j√° foi carregado
			    if (!document.querySelector(`script[src="${scriptUrl}"]`)) {
			        const script = document.createElement('script');
			        script.src = scriptUrl;
			        script.async = false; // Carrega na ordem
			        document.head.appendChild(script);
			        return new Promise((resolve) => {
			            script.onload = resolve; // Resolve a promise quando o script carregar
			        });
			    }
			    return Promise.resolve(); // Retorna uma promise resolvida se o script j√° existe
			}
			
			// Fun√ß√£o principal ajustada
			async function render_code3() {
			    const iaTags = document.querySelectorAll('ia');
			
			    for (const iaTag of iaTags) { // Usamos um loop 'for' para aguardar as promises
			        const content = iaTag.textContent;
			        const codeBlocks = content.match(/```(\w*)\n([\s\S]*?)```/g);
			
			        if (codeBlocks) {
			            const fragment = document.createDocumentFragment();
			            let remainingContent = content;
			
			            for (const block of codeBlocks) {
			                const match = block.match(/```(\w*)\n([\s\S]*?)```/);
			                if (!match) continue; // Pula se n√£o houver correspond√™ncia
			
			                let language = match[1].toLowerCase(); // Linguagem em min√∫sculas
			                const codeContent = match[2].trim(); // Conte√∫do do bloco
			
			                // Carrega o modo dinamicamente e aguarda
			                await loadModeScript(language);
			
			                const textBefore = remainingContent.split(block)[0];
			                if (textBefore) {
			                    const textNode = document.createTextNode(textBefore);
			                    fragment.appendChild(textNode);
			                }
			
			                const codeContainer = document.createElement('div');
			                codeContainer.classList.add('code-container');
			                fragment.appendChild(codeContainer);
			                carrega_tema();
			                const codeMirrorInstance = CodeMirror(codeContainer, {
			                    value: codeContent || '',
			                    mode: modes[language],
			                    //                     lineNumbers: true,
			                    theme: themes[currentThemeIndex],
			                    viewportMargin: Infinity,
			                    lineWrapping: true,
			                    readOnly: false
			                });
			
			                setTimeout(() => codeMirrorInstance.refresh(), 0);
			                remainingContent = remainingContent.split(block)[1] || '';
			            }
			
			            if (remainingContent) {
			                const textNode = document.createTextNode(remainingContent);
			                fragment.appendChild(textNode);
			            }
			
			            iaTag.innerHTML = '';
			            iaTag.appendChild(fragment);
			        }
			    }
			}
			
			function busca_palavra(button) {
			    const buscaElements = document.querySelectorAll('.busca');
			    // Verifica o estado atual do elemento .busca
			    const isHidden = buscaElements[0].classList.contains('hidden'); // Usa o primeiro elemento como refer√™ncia
			
			    if (isHidden) {
			        // Remove 'hidden' e troca o emoji do bot√£o para "fechar" (‚ùå)
			        buscaElements.forEach(element => {
			            element.classList.remove('hidden');
			        });
			        button.textContent = '‚ùå'; // Emoji de fechar no bot√£o
			    } else {
			        const previousHighlights = document.querySelectorAll('.highlight');
			        previousHighlights.forEach(highlight => {
			            const parent = highlight.parentNode;
			            parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
			            parent.normalize(); // Junta n√≥s de texto adjacentes
			        });
			        // Adiciona 'hidden' e troca o emoji do bot√£o para "lupa" (üîç)
			        buscaElements.forEach(element => {
			            element.classList.add('hidden');
			        });
			        button.textContent = 'üîç'; // Emoji de lupa no bot√£o
			    }
			
			    // Adiciona evento de clique no bot√£o apenas uma vez (j√° est√° impl√≠cito no onclick do HTML)
			}
			// let currentHighlightIndex = -1;
			
			let currentHighlightIndex = -1; // Declarado fora da fun√ß√£o para persistir entre chamadas
			
			function findNext() {
			    const findInput = document.getElementById('find');
			    const searchText = findInput.value.trim();
			
			    if (!searchText) return;
			
			    // Remove destaques anteriores
			    const previousHighlights = document.querySelectorAll('.highlight');
			    previousHighlights.forEach(highlight => {
			        const parent = highlight.parentNode;
			        parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
			        parent.normalize(); // Junta n√≥s de texto adjacentes
			    });
			
			    // Cria um TreeWalker para percorrer apenas n√≥s de texto
			    const walker = document.createTreeWalker(
			        document.body,
			        NodeFilter.SHOW_TEXT,
			        null,
			        false
			    );
			
			    const textNodes = [];
			    let node;
			    while ((node = walker.nextNode())) {
			        if (node.nodeValue.trim() && node.parentNode.tagName !== 'SCRIPT' && node.parentNode.tagName !== 'STYLE') {
			            textNodes.push(node); // Armazena apenas n√≥s de texto relevantes
			        }
			    }
			
			    // Busca e destaca o texto nos n√≥s coletados
			    const regex = new RegExp(`(${searchText})`, 'gi');
			    textNodes.forEach(textNode => { 
			        if (regex.test(textNode.nodeValue)) {
			            const fragment = document.createDocumentFragment();
			            const parts = textNode.nodeValue.split(regex);
			            parts.forEach(part => {
			                if (part.toLowerCase() === searchText.toLowerCase()) {
			                    const span = document.createElement('span');
			                    span.className = 'highlight';
			                    span.textContent = part;
			                    fragment.appendChild(span);
			                } else {
			                    fragment.appendChild(document.createTextNode(part));
			                }
			            });
			            textNode.parentNode.replaceChild(fragment, textNode);
			        }
			    });
			
			    // Navega para a pr√≥xima ocorr√™ncia
			    const highlights = document.querySelectorAll('.highlight');
			    if (highlights.length > 0) {
			        if (currentHighlightIndex ===
			
			            -1 || highlights.length <= currentHighlightIndex) {
			            currentHighlightIndex = 0; // Reseta se n√£o houver destaque ou √≠ndice inv√°lido
			        } else {
			            currentHighlightIndex = (currentHighlightIndex + 1) % highlights.length; // Cicla
			        }
			        const nextHighlight = highlights[currentHighlightIndex];
			        if (nextHighlight) {
			            nextHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
			        }
			    }
			}
			
			// Fun√ß√£o para alternar a rolagem autom√°tica
			function toggleAutoScroll() {
			    const toggleButton = document.getElementById('toggle-scroll'); 
			    window.scrollTo({
			        top: document.documentElement.scrollHeight,
			        behavior: 'smooth' // Rolagem suave
			    });
			    isAutoScrollEnabled = true;
			    toggleButton.style.display = 'none';
			}
			
			window.addEventListener('wheel', (event) => {
			    const toggleButton = document.getElementById('toggle-scroll');  
			    if (event.deltaY < 0) { // Rolagem para cima (deltaY negativo)
			        if (isAutoScrollEnabled) { // S√≥ atualiza se estava desativado
			            isAutoScrollEnabled = false;
			
			            toggleButton.textContent = 'üîª';
			            toggleButton.style.display = 'block';
			
			            console.log('Rolagem autom√°tica reativada por rolagem para cima');
			        }
			    }
			    // Verifica se est√° no final da p√°gina
			    const scrollPosition = window.scrollY + window.innerHeight;
			    const documentHeight = document.documentElement.scrollHeight;
			
			    if (scrollPosition >= documentHeight - 1) 
			        toggleButton.style.display = 'none'; 
			    else 
			        toggleButton.style.display = 'block'; 
			});
			
			
			function editarEspecialista(){
			    edit_especialista=true;
			    carregarEspecialista()
			}
			
			function excluirEspecialista(){
			    edit_especialista=false;
			    const especialistas = JSON.parse(localStorage.getItem('especialistas')) || {};
			    delete especialistas[nomeEspecialista];
			    localStorage.setItem('especialistas', JSON.stringify(especialistas));
			    carregarEspecialistasNoSelect(); 
			}
			function sairEspecialista(fechar){
			    const botao = event.currentTarget;
			    // Pega o elemento pai com a classe 'especial' mais pr√≥ximo do bot√£o
			    const divEspecial = botao.closest('.especial');
			    // Aplica o estilo apenas a essa div espec√≠fica
			    divEspecial.style.outline = '';
			    //     document.querySelector('.'+fechar).classList.add('hidden');
			    divEspecial.querySelector('.' + fechar).classList.add('hidden');
			
			}
			function criarEspecialista() {
			    const botao = event.currentTarget;
			    // Pega o elemento pai com a classe 'especial' mais pr√≥ximo do bot√£o
			    const divEspecial = botao.closest('.especial');
			    // Aplica o estilo apenas a essa div espec√≠fica
			    divEspecial.style.outline = '1px solid';
			
			    //    	const especial = document.getElementById('especial');
			    // 	especial.style.outline = '1px solid';
			    const promptText = document.getElementById('prompt').value.trim();
			    console.log(edit_especialista);
			    if (promptText === '') { 
			        // Se o prompt estiver vazio, mostra o select de especialistas
			        const selectEspecialistas = document.querySelector('.especialistas');
			        selectEspecialistas.classList.remove('hidden');
			        carregarEspecialistasNoSelect();
			    } else {
			        nomeEspecialista = window.prompt('Digite o nome do especialista:', nomeEspecialista);
			        if (nomeEspecialista) { 
			            const especialistas = JSON.parse(localStorage.getItem('especialistas') || '{}');
			            especialistas[nomeEspecialista] = promptText;
			            localStorage.setItem('especialistas', JSON.stringify(especialistas));
			            // Limpa o campo prompt
			            document.getElementById('prompt').value = '';
			            // Atualiza a lista de especialistas
			            carregarEspecialistasNoSelect(); 
			            edit_especialista=false;
			        }
			    }
			} 
			
			function carregarEspecialistasNoSelect() {
			    const selectEspecialistas = document.getElementById('especialistas');
			    selectEspecialistas.innerHTML = '';
			
			    const especialistas = JSON.parse(localStorage.getItem('especialistas') || '{}');
			    for (const [nome, texto] of Object.entries(especialistas)) {
			        const option = document.createElement('option');
			        option.value = nome;
			        option.textContent = nome;
			        selectEspecialistas.appendChild(option);
			    }
			}
			
			
			function carregarEspecialista() {
			    const selectEspecialistas = document.getElementById('especialistas');
			    nomeEspecialista = selectEspecialistas.value;
			    if (nomeEspecialista) { 
			        const especialistas = JSON.parse(localStorage.getItem('especialistas') || '{}');
			        if (edit_especialista)
			            document.getElementById('prompt').value = especialistas[nomeEspecialista] || '';
			        //         nome_especialista=
			        else
			            sytemPrompt= especialistas[nomeEspecialista];
			    }
			}
			
			
			// Fun√ß√£o para criar e exibir a legenda
			document.addEventListener('mouseover', function(event) {
			    if (event.target.hasAttribute('legenda')) {
			        const toolTip = event.target.getAttribute('legenda');
			
			        // Cria o elemento da legenda
			        const legenda = document.createElement('span');
			        legenda.className = 'legenda';
			        legenda.textContent = toolTip;
			
			        // Posiciona a legenda
			        legenda.style.position = 'absolute';
			        legenda.style.top = `${event.pageY - 10}px`;
			        legenda.style.left = `${event.pageX + 20}px`;
			        legenda.style.display = 'none'; // Inicialmente oculta
			
			        // Adiciona a legenda ao body
			        document.body.appendChild(legenda);
			
			        // Exibe a legenda com efeito de fadeIn
			        setTimeout(() => {
			            legenda.style.display = 'block';
			            legenda.style.opacity = '1';
			            legenda.style.transition = 'opacity 1s';
			        }, 100);
			    }
			});
			
			// Fun√ß√£o para remover a legenda ao sair do elemento
			document.addEventListener('mouseout', function(event) {
			    if (event.target.hasAttribute('legenda')) {
			        const legenda = document.querySelector('.legenda');
			        if (legenda) legenda.remove();
			    }
			});
			
			// Fun√ß√£o para mover a legenda com o mouse
			document.addEventListener('mousemove', function(event) {
			    const legenda = document.querySelector('.legenda');
			    if (legenda) {
			        legenda.style.top = `${event.pageY +10}px`; 
			        legenda.style.left = `${event.pageX + 20}px`;
			    }
			});
			
			
			window.onload = function() {
			    carregarModelosOllama();
			    carregarEspecialistasNoSelect(); 
			};
			
			
			function salvar_conversa(){
			    const iaElement = document.querySelector('ia');
			    const texto = iaElement.textContent;
			
			    // Extrair o texto entre os primeiros **
			    const regex = /\*\*(.*?)\*\*/;
			    const match = texto.match(regex);
			    const resultado = match ? match[1] : '';
			
			
			    conversa_nome = window.prompt('Nome para conversa:', resultado);
			    if (conversa_nome) { 
			        const conversas = JSON.parse(localStorage.getItem('conversas') || '{}');
			        conversas[conversa_nome] = conversationHistory;
			        localStorage.setItem('conversas', JSON.stringify(conversas));
			        carregarConversasSelect()
			        // Limpa o campo prompt
			        //             document.getElementById('prompt').value = '';
			        // Atualiza a lista de conversas
			        //             carregarEspecialistasNoSelect(); 
			        //             edit_especialista=false;
			    }
			}
			
			function abrirConversas (){
			
			    const botao = event.currentTarget;
			    const divEspecial = botao.closest('.especial');
			    divEspecial.style.outline = '1px solid';
			    const selectConversas = document.querySelector('.conversas');
			    selectConversas.classList.remove('hidden');
			    carregarConversasSelect()
			
			}
			
			function carregarConversasSelect() {
			    const selectConversas = document.getElementById('conversas');
			    selectConversas.innerHTML = '';
			    const optionSelecao = document.createElement('option');
			    optionSelecao.value = 'Selecione'; // Deixe vazio para que ela possa ser selecionada
			    optionSelecao.textContent = 'Selecione';
			    selectConversas.appendChild(optionSelecao);
			
			
			    const conversas = JSON.parse(localStorage.getItem('conversas') || '{}');
			    for (const [nome, texto] of Object.entries(conversas)) {
			        const option = document.createElement('option');
			        option.value = nome;
			        option.textContent = nome;
			        selectConversas.appendChild(option);
			    }
			}
			function excluirConversas(){
			    let nomeConversas=  document.getElementById('conversas').value
			    const conversas = JSON.parse(localStorage.getItem('conversas')) || {};
			    delete conversas[nomeConversas];
			    localStorage.setItem('conversas', JSON.stringify(conversas));
			    carregarConversasSelect(); 
			}
			function novaConversa(){
			    responseDiv.innerHTML="";
			    conversationHistory = [];
			}
			function carregarConversas (){
			    responseDiv.innerHTML="";
			    const selectConversas = document.getElementById('conversas');
			    nomeConversas = selectConversas.value;
			    if (nomeConversas == "Selecione") return;
			    const conversas = JSON.parse(localStorage.getItem('conversas') || '{}');
			    conversationHistory =conversas[nomeConversas];
			    conversationHistory.forEach((mensagem) => {
			        const tag = document.createElement(mensagem.role === 'user' ? 'eu' : 'ia');
			        tag.textContent = mensagem.content;
			        responseDiv.appendChild(tag);
			    });
			    render_code3();
			}
			
			console.clear(); 
			let tem_Code = false;
			let fullText ="";let codigo = '';
			function estilizar2 (text) {
			    if (!text) return '';
			
			
			    fullText += text; // Aqui voc√™ pode receber o texto fragmentado e juntar
			    if (!fullText.includes("\n")) return '';    
			    if (tem_Code) {
			        codigo += fullText; // Continuar acumulando o c√≥digo
			        if (fullText.includes('```')) {
			            tem_Code = false; // C√≥digo terminou
			            fullText="";  
			
			            return '#fim#\n';
			            //                     return '<pre><code>' + codigo + '</code></pre>';
			        }
			
			        fullText="";  
			        return "-"
			    } 
			    if (fullText.includes('```')){
			        tem_Code = true; // In√≠cio de bloco de c√≥digo
			        codigo = fullText; // Come√ßa a acumular c√≥digo
			        fullText="";        
			        return '#ini#'; // N√£o processa nada at√© terminar o c√≥digo
			
			    }
			
			    let textoFormatado = fullText.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
			    .replace(/__(.+?)__/g, '<strong>$1</strong>')
			    .replace(/\*(.+?)\*/g, '<em>$1</em>')
			    .replace(/_(.+?)_/g, '<em>$1</em>')
			    .replace(/# (.+)/g, '<h1>$1</h1>')
			    .replace(/## (.+)/g, '<h2>$1</h2>')
			    .replace(/### (.+)/g, '<h3>$1</h3>')
			    .replace(/^\- (.+)$/gm, ' - $1')
			    .replace(/^\* (.+)$/gm, ' * $1')
			    //     .replace(/`([^`]+)`/g, '<code>$1</code>')
			    .replace(/!\[([^\]]+)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
			    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
			    .replace(/^\> (.+)$/gm, '<blockquote>$1</blockquote>')
			    .replace(/\n---\n/g, '<hr>');
			
			    fullText="";
			    return textoFormatado;
			}
			
			
			let accumulatedMarkdown = ""; 
			let currentDiv = null; 
			let divCode = null;
			let cm = null;
			renderiza=false 
			let language;
			tem_Code = false 
			
			function carrega_tema() {
			    const newTheme = themes[currentThemeIndex];
			    const themeUrl = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/${newTheme}.min.css`;
			    const existingThemeLink = document.querySelector(`link[data-codemirror-theme="${newTheme}"]`);
			    if (existingThemeLink) return; 
			    const oldThemeLink = document.querySelector('link[data-codemirror-theme]');
			    if (oldThemeLink) oldThemeLink.remove();
			    const themeLink = document.createElement('link');
			    themeLink.rel = 'stylesheet';
			    themeLink.href = themeUrl;
			    themeLink.dataset.codemirrorTheme = newTheme; 
			    document.head.appendChild(themeLink);
			    document.querySelectorAll('.CodeMirror').forEach(cm => {
			        cm.classList.remove( "cm-s-"+themes[currentThemeIndex-1]);
			        cm.classList.add("cm-s-"+newTheme);
			    });
			}
			
			function changeTheme() {
			    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
			    carrega_tema();
			    setTimeout(() => {
			        const tema = document.querySelector(".cm-s-" + themes[currentThemeIndex]);
			        if (tema) {
			            const computedStyles = window.getComputedStyle(tema);
			            document.documentElement.style.setProperty('--color', computedStyles.color);
			            document.documentElement.style.setProperty('--bg-color', computedStyles.backgroundColor);
			        } else {
			            console.warn('Tema n√£o encontrado:', themes[currentThemeIndex]);
			        }
			    }, 500);
			}
			
			
			function createCodeMirrorInstance() {
			    const textarea = document.createElement('textarea');
			    divCode.appendChild(textarea);
			    cm = CodeMirror.fromTextArea(textarea, {
			        lineNumbers: true,
			        theme: themes[currentThemeIndex],
			        viewportMargin: Infinity,
			        lineWrapping: true,
			    });
			    return cm;
			}
			function createNewFragmentDiv2(tempResponse) {
			    const div = document.createElement('div');
			    div.className = 'ff';
			    tempResponse.appendChild(div);
			    return div;
			}
			
			function createNewFragmentDiv(tempResponse) {
			    const div = document.createElement('div');
			    div.className = 'ff';
			    console.log(tempResponse);
			    tempResponse.appendChild(div);
			    return div;
			}
			
			function estilizar (fragment,tempResponse){
			    if (!fragment) return '';
			
			    if (tem_Code) {
			        codigo += fragment; // Continuar acumulando o c√≥digo
			        if (!language){
			            const match = codigo.match(/```(\w+)/);
			            codigo = ""; 
			            fragment="";
			            language = match ? match[1] : null;
			            carrega_tema();
			            return;
			        }
			        if (fragment.includes('`\n')) {
			            tem_Code = false; 
			            fragment=""; 
			            language="";
			            codigo="";
			            return;
			        }   
			
			        cm.replaceRange(fragment.replace(/`+/g, ''), { 
			            line: cm.lastLine(),
			            ch: cm.getLine(cm.lastLine()).length });
			        return;
			    } 
			    if (fragment.includes('```')){
			        codigo += fragment; 
			        tem_Code = true; 
			        divCode = createNewFragmentDiv(tempResponse); 
			        cm = createCodeMirrorInstance(); 
			        return
			    }
			
			    if (!tem_Code) 
			        currentDiv.appendChild(document.createTextNode(fragment));
			    accumulatedMarkdown += fragment;
			
			    if (fragment.includes('\n')) renderiza = true
			    if (fragment.includes('|\n')) {renderiza =false; isTable= true;}
			    if (fragment.includes('* ')|fragment.includes('- ')) renderiza = false
			
			    if (renderiza) {
			        const selection = window.getSelection();
			        const selectedRange = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
			        currentDiv.innerHTML = marked.parse(accumulatedMarkdown);
			        if (selectedRange) {
			            selection.removeAllRanges();
			            selection.addRange(selectedRange);
			        }
			        accumulatedMarkdown = "";
			        currentDiv = createNewFragmentDiv(tempResponse);
			        renderiza=false;
			    }
			}
			
		</script>
	</body>
</html>